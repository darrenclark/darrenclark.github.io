<html>
<head>
  
  
  
    
    
  

  <title>Coalescing Updates With Dispatch Sources | Darren Clark</title>

  
  
  <link rel=stylesheet type="text/css" href="https://darrenclark.ca/style.55ea75016c92fcf3dde1d2b029c4e0f849556e63f91e41e6c7afa9d5cba4dce9362cb2892d5f6905222002dc052eac52d36eaa90e4f24c57689c3459ef8b3a08.css"></script>

  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="canonical" content="https://darrenclark.ca/coalescing-updates-with-dispatch-sources/">

  <link rel="alternate" type="application/rss+xml" title="Feed for darrenclark.ca" href="/feed.xml" />

  <meta property="og:title" content="Coalescing Updates With Dispatch Sources">
  <meta property="og:site_name" content="Darren Clark">
  <meta property="og:url" content="https://darrenclark.ca/coalescing-updates-with-dispatch-sources/">
  <meta property="og:image" content="https://darrenclark.ca/apple-touch-icon.png" />

  
  <meta property="og:type" content="article">
  <meta property="og:description" content="Today we use DispatchSourceUserDataAdd to coalesce calls to UITableView.reloadData()">
  <meta name="description" content="Today we use DispatchSourceUserDataAdd to coalesce calls to UITableView.reloadData()">
  


  
  
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-NL59FNTT94"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-NL59FNTT94');
  </script>
  

</head>
<body class="bg-bg-light dark:bg-bg-dark text-gray-700 dark:text-gray-200 transition-colors duration-300">
    <div class="max-w-3xl mx-auto px-6 md:px-8 py-8">
        
        <header class="mb-16 pb-6 border-b-2 border-border-light dark:border-border-dark">
            <div class="flex justify-between items-center mb-5 md:mb-0">
                <h1 class="text-2xl font-bold">
                    <a href="/" class="text-gray-700 dark:text-gray-200 hover:text-link-light dark:hover:text-link-dark transition-colors">Darren Clark</a>
                </h1>
                <div class="flex items-center gap-6">
                    <nav class="hidden md:flex gap-6">
                        <a href="/about" class="text-gray-500 dark:text-gray-400 hover:text-link-light dark:hover:text-link-dark transition-colors text-[0.95rem]">About</a>
                        <a href="/articles" class="text-gray-500 dark:text-gray-400 hover:text-link-light dark:hover:text-link-dark transition-colors text-[0.95rem]">Articles</a>
                    </nav>
                    <div class="flex items-center gap-4">
                        <a href="https://github.com/darrenclark" aria-label="GitHub" class="text-gray-500 dark:text-gray-400 hover:text-link-light dark:hover:text-link-dark transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5">
                                <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
                            </svg>
                        </a>
                        <button onclick="toggleTheme()" aria-label="Toggle theme" class="text-gray-500 dark:text-gray-400 hover:text-link-light dark:hover:text-link-dark transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-[22px] h-[22px]">
                                <path d="M12 2.25a.75.75 0 01.75.75v2.25a.75.75 0 01-1.5 0V3a.75.75 0 01.75-.75zM7.5 12a4.5 4.5 0 119 0 4.5 4.5 0 01-9 0zM18.894 6.166a.75.75 0 00-1.06-1.06l-1.591 1.59a.75.75 0 101.06 1.061l1.591-1.59zM21.75 12a.75.75 0 01-.75.75h-2.25a.75.75 0 010-1.5H21a.75.75 0 01.75.75zM17.834 18.894a.75.75 0 001.06-1.06l-1.59-1.591a.75.75 0 10-1.061 1.06l1.59 1.591zM12 18a.75.75 0 01.75.75V21a.75.75 0 01-1.5 0v-2.25A.75.75 0 0112 18zM7.758 17.303a.75.75 0 00-1.061-1.06l-1.591 1.59a.75.75 0 001.06 1.061l1.591-1.59zM6 12a.75.75 0 01-.75.75H3a.75.75 0 010-1.5h2.25A.75.75 0 016 12zM6.697 7.757a.75.75 0 001.06-1.06l-1.59-1.591a.75.75 0 00-1.061 1.06l1.59 1.591z" />
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
            <nav class="flex md:hidden justify-center gap-8 mt-5">
                <a href="/about" class="text-gray-500 dark:text-gray-400 hover:text-link-light dark:hover:text-link-dark transition-colors text-[0.95rem] py-2 px-3 min-h-[44px] flex items-center">About</a>
                <a href="/articles" class="text-gray-500 dark:text-gray-400 hover:text-link-light dark:hover:text-link-dark transition-colors text-[0.95rem] py-2 px-3 min-h-[44px] flex items-center">Articles</a>
            </nav>
        </header>

        
        <main>
            
<article>
    <div class="mb-12">
        <h2 class="text-[2rem] font-bold mb-3 leading-tight">Coalescing Updates With Dispatch Sources</h2>
        <div class="text-gray-500 dark:text-gray-400 text-[0.95rem]">
            Published on Dec 27, 2018
            
            in
            
                
                <a href="/tags/swift" class="text-link-light dark:text-link-dark hover:opacity-70">#swift</a>
            
            
        </div>
    </div>

    <div class="markdown prose prose-lg max-w-none">
        <p>Today I wanted to look at using <code>DispatchSourceUserDataAdd</code> to coalesce calls to (potentially expensive) functions like <code>UITableView.reloadData()</code>.</p>
<p>If you want to follow along in Xcode, feel free to copy/paste <a href="https://gist.github.com/darrenclark/fa32cb5953ae6ccca16366b44098101a">this gist</a> into an iOS Playground.</p>
<h1 id="background">Background</h1>
<center>
<img src="/images/2018-12-27-todo-list.png" alt="App screenshot" style="max-width: 280" />
</center>
<p>The example follows the patterns described in Apple&rsquo;s documentation on <a href="https://developer.apple.com/library/archive/documentation/General/Conceptual/DevPedia-CocoaCore/MVC.html">Model-View-Controller</a>.</p>
<p>Our &ldquo;Model&rdquo; layer is compromised of the <code>TodoList</code> and <code>TodoListItem</code> classes.  In reaction to user input, we can mark items as completed by setting the <code>TodoListItem.completed</code> property to <code>true</code>.  And, we can listen for changes by observing the <code>TodoListItemUpdated</code> notification.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-swift" data-lang="swift"><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">TodoList</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kd">static</span> <span class="kd">let</span> <span class="nv">shared</span> <span class="p">=</span> <span class="n">TodoList</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">var</span> <span class="nv">items</span><span class="p">:</span> <span class="p">[</span><span class="n">TodoListItem</span><span class="p">]</span> <span class="p">=</span> <span class="p">[</span> <span class="cm">/*...*/</span> <span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// ...</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">extension</span> <span class="nc">NSNotification</span><span class="p">.</span><span class="n">Name</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kd">static</span> <span class="kd">let</span> <span class="nv">todoListItemUpdated</span> <span class="p">=</span> <span class="n">NSNotification</span><span class="p">.</span><span class="n">Name</span><span class="p">(</span><span class="s">&#34;TodoListItemUpdated&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">TodoListItem</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kd">let</span> <span class="nv">title</span><span class="p">:</span> <span class="nb">String</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">var</span> <span class="nv">completed</span><span class="p">:</span> <span class="nb">Bool</span> <span class="p">=</span> <span class="kc">false</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kr">didSet</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">NotificationCenter</span><span class="p">.</span><span class="k">default</span><span class="p">.</span><span class="n">post</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="p">.</span><span class="n">todoListItemUpdated</span><span class="p">,</span> <span class="n">object</span><span class="p">:</span> <span class="kc">self</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// ...</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Our &ldquo;Controller&rdquo; layer is a subclass of <code>UITableViewController</code>.  It gets data from our model (<code>TodoList</code>) and displays it in a table view.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-swift" data-lang="swift"><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">ViewController</span><span class="p">:</span> <span class="n">UITableViewController</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// ...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">override</span> <span class="kd">func</span> <span class="nf">tableView</span><span class="p">(</span><span class="kc">_</span> <span class="n">tableView</span><span class="p">:</span> <span class="n">UITableView</span><span class="p">,</span> <span class="n">numberOfRowsInSection</span> <span class="n">section</span><span class="p">:</span> <span class="nb">Int</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="nb">Int</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">TodoList</span><span class="p">.</span><span class="n">shared</span><span class="p">.</span><span class="n">items</span><span class="p">.</span><span class="bp">count</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">override</span> <span class="kd">func</span> <span class="nf">tableView</span><span class="p">(</span><span class="kc">_</span> <span class="n">tableView</span><span class="p">:</span> <span class="n">UITableView</span><span class="p">,</span> <span class="n">cellForRowAt</span> <span class="n">indexPath</span><span class="p">:</span> <span class="n">IndexPath</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">UITableViewCell</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nv">cell</span> <span class="p">=</span> <span class="n">tableView</span><span class="p">.</span><span class="n">dequeueReusableCell</span><span class="p">(</span><span class="n">withIdentifier</span><span class="p">:</span> <span class="s">&#34;Cell&#34;</span><span class="p">,</span> <span class="k">for</span><span class="p">:</span> <span class="n">indexPath</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nv">item</span> <span class="p">=</span> <span class="n">TodoList</span><span class="p">.</span><span class="n">shared</span><span class="p">.</span><span class="n">items</span><span class="p">[</span><span class="n">indexPath</span><span class="p">.</span><span class="n">row</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// configure cell ...</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">cell</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  <span class="c1">// ...</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>When a user taps an item, we <a href="https://github.com/apple/swift-evolution/blob/master/proposals/0199-bool-toggle.md">toggle</a> its <code>completed</code> property.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-swift" data-lang="swift"><span class="line"><span class="cl">  <span class="kr">override</span> <span class="kd">func</span> <span class="nf">tableView</span><span class="p">(</span><span class="kc">_</span> <span class="n">tableView</span><span class="p">:</span> <span class="n">UITableView</span><span class="p">,</span> <span class="n">didSelectRowAt</span> <span class="n">indexPath</span><span class="p">:</span> <span class="n">IndexPath</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">TodoList</span><span class="p">.</span><span class="n">shared</span><span class="p">.</span><span class="n">items</span><span class="p">[</span><span class="n">indexPath</span><span class="p">.</span><span class="n">row</span><span class="p">].</span><span class="n">completed</span><span class="p">.</span><span class="n">toggle</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span></code></pre></div><p>In turn, the <code>TodoListItem</code> posts the <code>TodoListItemUpdated</code> notification, and our view controller reloads our table view, updating the UI for the user.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-swift" data-lang="swift"><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">ViewController</span><span class="p">:</span> <span class="n">UITableViewController</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">override</span> <span class="kd">func</span> <span class="nf">viewDidLoad</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">NotificationCenter</span><span class="p">.</span><span class="k">default</span><span class="p">.</span><span class="n">addObserver</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="kc">self</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="n">selector</span><span class="p">:</span> <span class="k">#selector</span><span class="p">(</span><span class="n">todoListItemUpdated</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">      <span class="n">name</span><span class="p">:</span> <span class="p">.</span><span class="n">todoListItemUpdated</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="n">object</span><span class="p">:</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// ...</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">@objc</span> <span class="kd">func</span> <span class="nf">todoListItemUpdated</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">tableView</span><span class="p">.</span><span class="n">reloadData</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>And everything works great.  Since our <code>ViewController</code> observes changes to our model layer directly (via <code>NotificationCenter</code>), we never have to worry about our UI getting out of sync with our data.</p>
<p>As a convenience to our users, we decide to add a shortcut to mark all items as completed.  Firstly, we update our <code>TodoList</code> class with a function to mark all items completed.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-swift" data-lang="swift"><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">TodoList</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// ...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">func</span> <span class="nf">markAllAsCompleted</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">item</span> <span class="k">in</span> <span class="n">items</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">item</span><span class="p">.</span><span class="n">completed</span> <span class="p">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>And wire up a button to call <code>markAllAsCompleted()</code>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-swift" data-lang="swift"><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">ViewController</span><span class="p">:</span> <span class="n">UITableViewController</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">override</span> <span class="kd">func</span> <span class="nf">viewDidLoad</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">navigationItem</span><span class="p">.</span><span class="n">rightBarButtonItem</span> <span class="p">=</span> <span class="n">UIBarButtonItem</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="n">title</span><span class="p">:</span> <span class="s">&#34;Complete All&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="n">style</span><span class="p">:</span> <span class="p">.</span><span class="n">plain</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="n">target</span><span class="p">:</span> <span class="kc">self</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="n">action</span><span class="p">:</span> <span class="k">#selector</span><span class="p">(</span><span class="n">completeAll</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// ...</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">@objc</span> <span class="kd">func</span> <span class="nf">completeAll</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">TodoList</span><span class="p">.</span><span class="n">shared</span><span class="p">.</span><span class="n">markAllAsCompleted</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// ...</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Since our <code>ViewController</code> observes changes to our model via <code>NotificationCenter</code>, it automatically updates the UI in response to the user tapping the &lsquo;Complete All&rsquo; button.</p>
<h1 id="the-problem">The Problem</h1>
<p>Some of you may have already noticed one small issue.</p>
<ol>
<li>The <code>markAllAsCompleted()</code> function sets <code>completed = true</code> on all of our <code>TodoListItem</code>s</li>
<li>Each <code>TodoListItem</code> posts a <code>TodoListItemUpdated</code> notification</li>
<li>For each <code>TodoListItemUpdated</code> notification, our <code>ViewController</code> calls <code>tableView.reloadData()</code></li>
</ol>
<p>To confirm this, I&rsquo;ve added a <code>print</code> statement when <code>tableView.reloadData()</code> is called.</p>
<center>
<img src="/images/2018-12-27-broken.png" alt="Xcode screenshot demonstrating the bug" />
</center>
<p>Sure enough!  Tapping &lsquo;Complete All&rsquo; printed out five messages, one for each item we have.</p>
<p>Perhaps not a big issue if we have one, two, or even five items, but it could be if we have fifty or one hundred items.  While our code is simple and fairly straightforward, we are unnecessary calling <code>tableView.reloadData()</code> a lot!  We should take a look into this before shipping our app.</p>
<h1 id="the-solution">The Solution</h1>
<p>Ideally we want to coalesce all of changes into a single call to <code>tableView.reloadData()</code>.  Thankfully, Grand Central Dispatch provides us the perfect tool for the job - <a href="https://developer.apple.com/documentation/dispatch/dispatchsourceuserdataadd"><code>DispatchSourceUserDataAdd</code></a>.</p>
<h2 id="dispatch-sources">Dispatch Sources</h2>
<p>Dispatch Sources are special objects that schedule blocks to run when certain low level events happen.  For example, <a href="https://developer.apple.com/documentation/dispatch/dispatchsourcesignal"><code>DispatchSourceSignal</code></a> will enqueue a block on a given <code>DispatchQueue</code> when the current process receives certain Unix signals.  As many of these are wrapped up in higher level APIs in <code>Foundation.framework</code> or elsewhere, it&rsquo;s pretty rare to use Dispatch Sources directly.  However, there are a couple Dispatch Sources that are quite useful for us:</p>
<ul>
<li><a href="https://developer.apple.com/documentation/dispatch/dispatchsourceuserdataadd"><code>DispatchSourceUserDataAdd</code></a></li>
<li><a href="https://developer.apple.com/documentation/dispatch/dispatchsourceuserdataor"><code>DispatchSourceUserDataOr</code></a></li>
<li><a href="https://developer.apple.com/documentation/dispatch/dispatchsourceuserdatareplace"><code>DispatchSourceUserDataReplace</code></a> - at the time of this writing, this one isn&rsquo;t documented in the <a href="https://developer.apple.com/documentation/dispatch/dispatch_source_type_constants?language=objc">Objective-C documentation</a></li>
</ul>
<p>All three of these operate in roughly the same way:</p>
<ul>
<li>They all store a <code>UInt</code> <em>user data</em></li>
<li>The <em>user data</em> can be manipulated by us (the user of this API) via these methods (respectively):
<ul>
<li><code>func add(data: UInt)</code> - increments the <em>user data</em> by <code>data</code></li>
<li><code>func merge(data: UInt)</code> - bitwise ORs the <em>user data</em> with <code>data</code></li>
<li><code>func replace(data: UInt)</code> - sets the <em>user data</em> to <code>data</code></li>
</ul>
</li>
<li>When the <em>user data</em> becomes non-zero, it enqueues a block to run on a Dispatch Queue</li>
<li>After the block is run, the <em>user data</em> is set back to zero</li>
</ul>
<p>Of particular interest to us is the fact that a block is only enqueued when the <em>user data</em> becomes non-zero, not each time it is updated.</p>
<h2 id="using-dispatchsourceuserdataadd">Using <code>DispatchSourceUserDataAdd</code></h2>
<p>Despite being advertised as &ldquo;low-level&rdquo;, <code>DispatchSourceUserDataAdd</code> is fairly straightforward.  First we create one via the <code>DispatchSource.makeUserDataAddSource(queue:)</code> function.  We&rsquo;ll put this in our <code>ViewController</code> class.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-swift" data-lang="swift"><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">ViewController</span><span class="p">:</span> <span class="n">UITableViewController</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kd">let</span> <span class="nv">dispatchSource</span> <span class="p">=</span> <span class="n">DispatchSource</span><span class="p">.</span><span class="n">makeUserDataAddSource</span><span class="p">(</span><span class="n">queue</span><span class="p">:</span> <span class="p">.</span><span class="n">main</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   
</span></span><span class="line"><span class="cl">  <span class="c1">// ...</span>
</span></span></code></pre></div><p>Then we need to set an event handler, a.k.a. the block that will be queued when the <em>user data</em> becomes non-zero.</p>
<p>After that, we&rsquo;ll call <code>dispatchSource.resume()</code> to &ldquo;start&rdquo; the dispatch source (by default, dispatch sources started in a suspended state)</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-swift" data-lang="swift"><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">ViewController</span><span class="p">:</span> <span class="n">UITableViewController</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kd">let</span> <span class="nv">dispatchSource</span> <span class="p">=</span> <span class="n">DispatchSource</span><span class="p">.</span><span class="n">makeUserDataAddSource</span><span class="p">(</span><span class="n">queue</span><span class="p">:</span> <span class="p">.</span><span class="n">main</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">override</span> <span class="kd">func</span> <span class="nf">viewDidLoad</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">dispatchSource</span><span class="p">.</span><span class="n">setEventHandler</span><span class="p">(</span><span class="n">handler</span><span class="p">:</span> <span class="p">{</span> <span class="p">[</span><span class="kr">weak</span> <span class="kc">self</span><span class="p">]</span> <span class="k">in</span>
</span></span><span class="line"><span class="cl">      <span class="bp">print</span><span class="p">(</span><span class="s">&#34;tableView.reloadData()&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="kc">self</span><span class="p">?.</span><span class="n">tableView</span><span class="p">.</span><span class="n">reloadData</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">})</span>
</span></span><span class="line"><span class="cl">    <span class="n">dispatchSource</span><span class="p">.</span><span class="n">resume</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// ...</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span></code></pre></div><p>Finally, we update our <code>todoListItemUpdated()</code> function to use the dispatch source instead of calling <code>tableView.reloadData()</code> directly.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-swift" data-lang="swift"><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">ViewController</span><span class="p">:</span> <span class="n">UITableViewController</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// ...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">@objc</span> <span class="kd">func</span> <span class="nf">todoListItemUpdated</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Previously:</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//  print(&#34;tableView.reloadData()&#34;)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//  tableView.reloadData()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">dispatchSource</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span></code></pre></div><p>Let&rsquo;s give this a go in Xcode&hellip;</p>
<center>
<img src="/images/2018-12-27-fixed.png" alt="Xcode screenshot demonstrating that the bug is fixed" />
</center>
<p>Perfect! Our code only called <code>tableView.reloadData()</code> once, despite getting five <code>TodoListItemUpdated</code> notifications.</p>
<h1 id="final-thoughts">Final Thoughts</h1>
<p>I&rsquo;ve put the final code up in <a href="https://gist.github.com/darrenclark/7f8ef59097aa7ee7e6f79d301fac8ec0">this gist</a>.</p>
<p>Before using this elsewhere in our app, we may want to extract this into an extension, base class, or even another class to make it a little more ergonomic.  Rather than calling a function like <code>add(data: 1)</code> to signal a <code>reloadData()</code> is needed, it&rsquo;d be much nicer to call a function named <code>setNeedsReloadData()</code> or similar.</p>
<p>Also, depending on our use cases, we might want to take a look at <code>DispatchSourceUserDataOr</code>.  Since it combines data together via a bitwise OR, we could use a bitmask to signal different types of updates are needed, rather than doing a full <code>reloadData()</code> each time.</p>
<p>Finally, I&rsquo;d encourage you to read over <a href="https://developer.apple.com/documentation/DISPATCH">Apple&rsquo;s Dispatch documentation</a>, Grand Central Dispatch has quite a few interesting APIs in it.</p>

    </div>
</article>

        </main>

        
        <footer class="mt-20 pt-8 border-t border-border-light dark:border-border-dark text-center text-gray-500 dark:text-gray-400 text-sm">
            <p>Â© 2025 Darren Clark</p>
            <p class="mt-1">
                <a href="http://creativecommons.org/licenses/by-sa/2.5/ca/" class="text-link-light dark:text-link-dark hover:opacity-70">CC BY-SA 2.5 CA</a> (content) / 
                <a href="https://unlicense.org" class="text-link-light dark:text-link-dark hover:opacity-70">Unlicense</a> (code snippets)
            </p>
        </footer>
    </div>

    <script>
        function toggleTheme() {
            const html = document.documentElement;
            if (html.classList.contains('dark')) {
                html.classList.remove('dark');
                localStorage.setItem('theme', 'light');
            } else {
                html.classList.add('dark');
                localStorage.setItem('theme', 'dark');
            }
        }

        
        const savedTheme = localStorage.getItem('theme') || 'light';
        if (savedTheme === 'dark') {
            document.documentElement.classList.add('dark');
        }
    </script>
</body>
</html>
