<html>
<head>
  
  
  
    
    
  

  <title>How can I test Kubernetes permissions? | Darren Clark</title>

  
  
  <link rel=stylesheet type="text/css" href="https://darrenclark.ca/style.55ea75016c92fcf3dde1d2b029c4e0f849556e63f91e41e6c7afa9d5cba4dce9362cb2892d5f6905222002dc052eac52d36eaa90e4f24c57689c3459ef8b3a08.css"></script>

  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="canonical" content="https://darrenclark.ca/how-can-i-test-kubernetes-permissions/">

  <link rel="alternate" type="application/rss+xml" title="Feed for darrenclark.ca" href="/feed.xml" />

  <meta property="og:title" content="How can I test Kubernetes permissions?">
  <meta property="og:site_name" content="Darren Clark">
  <meta property="og:url" content="https://darrenclark.ca/how-can-i-test-kubernetes-permissions/">
  <meta property="og:image" content="https://darrenclark.ca/apple-touch-icon.png" />

  
  <meta property="og:type" content="article">
  <meta property="og:description" content="Or, ‚Äúimpersonating a service account with kubectl to verify permissions are correctly configured‚Äù">
  <meta name="description" content="Or, ‚Äúimpersonating a service account with kubectl to verify permissions are correctly configured‚Äù">
  


  
  
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-NL59FNTT94"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-NL59FNTT94');
  </script>
  

</head>
<body class="bg-bg-light dark:bg-bg-dark text-gray-700 dark:text-gray-200 transition-colors duration-300">
    <div class="max-w-3xl mx-auto px-6 md:px-8 py-8">
        
        <header class="mb-16 pb-6 border-b-2 border-border-light dark:border-border-dark">
            <div class="flex justify-between items-center mb-5 md:mb-0">
                <h1 class="text-2xl font-bold">
                    <a href="/" class="text-gray-700 dark:text-gray-200 hover:text-link-light dark:hover:text-link-dark transition-colors">Darren Clark</a>
                </h1>
                <div class="flex items-center gap-6">
                    <nav class="hidden md:flex gap-6">
                        <a href="/about" class="text-gray-500 dark:text-gray-400 hover:text-link-light dark:hover:text-link-dark transition-colors text-[0.95rem]">About</a>
                        <a href="/articles" class="text-gray-500 dark:text-gray-400 hover:text-link-light dark:hover:text-link-dark transition-colors text-[0.95rem]">Articles</a>
                    </nav>
                    <div class="flex items-center gap-4">
                        <a href="https://github.com/darrenclark" aria-label="GitHub" class="text-gray-500 dark:text-gray-400 hover:text-link-light dark:hover:text-link-dark transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5">
                                <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
                            </svg>
                        </a>
                        <button onclick="toggleTheme()" aria-label="Toggle theme" class="text-gray-500 dark:text-gray-400 hover:text-link-light dark:hover:text-link-dark transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-[22px] h-[22px]">
                                <path d="M12 2.25a.75.75 0 01.75.75v2.25a.75.75 0 01-1.5 0V3a.75.75 0 01.75-.75zM7.5 12a4.5 4.5 0 119 0 4.5 4.5 0 01-9 0zM18.894 6.166a.75.75 0 00-1.06-1.06l-1.591 1.59a.75.75 0 101.06 1.061l1.591-1.59zM21.75 12a.75.75 0 01-.75.75h-2.25a.75.75 0 010-1.5H21a.75.75 0 01.75.75zM17.834 18.894a.75.75 0 001.06-1.06l-1.59-1.591a.75.75 0 10-1.061 1.06l1.59 1.591zM12 18a.75.75 0 01.75.75V21a.75.75 0 01-1.5 0v-2.25A.75.75 0 0112 18zM7.758 17.303a.75.75 0 00-1.061-1.06l-1.591 1.59a.75.75 0 001.06 1.061l1.591-1.59zM6 12a.75.75 0 01-.75.75H3a.75.75 0 010-1.5h2.25A.75.75 0 016 12zM6.697 7.757a.75.75 0 001.06-1.06l-1.59-1.591a.75.75 0 00-1.061 1.06l1.59 1.591z" />
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
            <nav class="flex md:hidden justify-center gap-8 mt-5">
                <a href="/about" class="text-gray-500 dark:text-gray-400 hover:text-link-light dark:hover:text-link-dark transition-colors text-[0.95rem] py-2 px-3 min-h-[44px] flex items-center">About</a>
                <a href="/articles" class="text-gray-500 dark:text-gray-400 hover:text-link-light dark:hover:text-link-dark transition-colors text-[0.95rem] py-2 px-3 min-h-[44px] flex items-center">Articles</a>
            </nav>
        </header>

        
        <main>
            
<article>
    <div class="mb-12">
        <h2 class="text-[2rem] font-bold mb-3 leading-tight">How can I test Kubernetes permissions?</h2>
        <div class="text-gray-500 dark:text-gray-400 text-[0.95rem]">
            Published on Nov 15, 2020
            
            in
            
                
                <a href="/tags/kubernetes" class="text-link-light dark:text-link-dark hover:opacity-70">#kubernetes</a>
            
            
        </div>
    </div>

    <div class="markdown prose prose-lg max-w-none">
        <p>They say a <code>bash</code> one-liner is worth a thousand words, or something like that&hellip;</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubectl --as system:serviceaccount:default:myapp get pods
</span></span><span class="line"><span class="cl"><span class="c1"># Error from server (Forbidden): pods is forbidden: User </span>
</span></span><span class="line"><span class="cl"><span class="c1"># &#34;system:serviceaccount:default:myapp&#34; cannot list resource </span>
</span></span><span class="line"><span class="cl"><span class="c1"># &#34;pods&#34; in API group &#34;&#34; in the namespace &#34;default&#34;</span>
</span></span></code></pre></div><hr>
<p>Recently I found myself setting up a <a href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/">Kubernetes service account</a> to give my application read access to some Kubernetes resources.  Following the <a href="https://en.wikipedia.org/wiki/Principle_of_least_privilege">principle of least privilege</a>, I wanted to ensure my application had the absolute minimum access it needed.</p>
<p>As I prepared the Kubernetes YAML files, I wondered how I could test these locally before deploying.  Follow along below to see the process I used.</p>
<h1 id="setting-the-stage">Setting the Stage</h1>
<p>First, we&rsquo;ll need a Kubernetes cluster to test on.</p>
<p>I&rsquo;m going to use <a href="https://minikube.sigs.k8s.io/docs/start/"><code>minikube</code></a> to create a test cluster on my laptop, but any Kubernetes cluster will work.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">minikube start
</span></span><span class="line"><span class="cl"><span class="c1"># üòÑ  minikube v1.15.0 on Darwin 10.15.5</span>
</span></span><span class="line"><span class="cl"><span class="c1"># ‚ú®  Automatically selected the docker driver. Other choices: hyperkit, virtualbox</span>
</span></span><span class="line"><span class="cl"><span class="c1"># üëç  Starting control plane node minikube in cluster minikube</span>
</span></span><span class="line"><span class="cl"><span class="c1"># .....</span>
</span></span><span class="line"><span class="cl"><span class="c1"># üèÑ  Done! kubectl is now configured to use &#34;minikube&#34; cluster and &#34;default&#34; namespace by default</span>
</span></span></code></pre></div><h1 id="meet-alice-and-bob">Meet Alice and Bob</h1>
<p>We&rsquo;ll need two test subjects (pun intended).  I&rsquo;ve put together a Kubernetes config that:</p>
<ul>
<li>Creates two service accounts, <code>alice</code> and <code>bob</code></li>
<li>Grants both <code>alice</code> and <code>bob</code> permissions to view <a href="https://kubernetes.io/docs/concepts/workloads/controllers/job/">Kubernetes jobs</a></li>
<li>Grants <code>alice</code> permissions to create new jobs</li>
</ul>
<p>You can <a href="https://gist.github.com/darrenclark/1e0810a0e864efe9bb712d3d0dd991c7#file-service-accounts-and-permissions-yaml">view the gist on Github</a>.  We&rsquo;ll apply it to our Minikube cluster:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">kubectl apply -f https://gist.githubusercontent.com/darrenclark/1e0810a0e864efe9bb712d3d0dd991c7/raw/83458fdf93c3aea1be292506e28a26c73e68e9db/service-accounts-and-permissions.yaml
</span></span><span class="line"><span class="cl"><span class="c1"># serviceaccount/alice created</span>
</span></span><span class="line"><span class="cl"><span class="c1"># serviceaccount/bob created</span>
</span></span><span class="line"><span class="cl"><span class="c1"># role.rbac.authorization.k8s.io/jobs-viewer created</span>
</span></span><span class="line"><span class="cl"><span class="c1"># role.rbac.authorization.k8s.io/jobs-manager created</span>
</span></span><span class="line"><span class="cl"><span class="c1"># rolebinding.rbac.authorization.k8s.io/alice-and-bob-jobs-viewer created</span>
</span></span><span class="line"><span class="cl"><span class="c1"># rolebinding.rbac.authorization.k8s.io/alice-jobs-manager created</span>
</span></span></code></pre></div><h1 id="testing-out-our-permissions">Testing out our permissions</h1>
<p>Let&rsquo;s test out the permissions on our newly created service accounts.  Lucky for us, <code>kubectl</code> has the perfect tool for the job.  From the man page:</p>
<pre tabindex="0"><code>    --as=&#34;&#34;      Username to impersonate for the operation
</code></pre><p>This allows us to run <code>kubectl</code> as if we were <code>alice</code> or <code>bob</code>.</p>
<p>We can use the Job definition in <a href="https://gist.github.com/darrenclark/1e0810a0e864efe9bb712d3d0dd991c7#file-job-yaml">this Gist</a> to test it out.</p>
<h2 id="testing-alices-permissions">Testing <code>alice</code>&rsquo;s permissions</h2>
<p>Let&rsquo;s try creating a job with <code>alice</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">kubectl create <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --as<span class="o">=</span>system:serviceaccount:default:alice <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  -f https://gist.githubusercontent.com/darrenclark/1e0810a0e864efe9bb712d3d0dd991c7/raw/83458fdf93c3aea1be292506e28a26c73e68e9db/job.yaml
</span></span><span class="line"><span class="cl"><span class="c1"># job.batch/echo-job-jv8jh created</span>
</span></span></code></pre></div><p>And viewing that job as <code>alice</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">kubectl --as<span class="o">=</span>system:serviceaccount:default:alice get <span class="nb">jobs</span>
</span></span><span class="line"><span class="cl"><span class="c1"># NAME             COMPLETIONS   DURATION   AGE</span>
</span></span><span class="line"><span class="cl"><span class="c1"># echo-job-jv8jh   1/1           3s         39s</span>
</span></span></code></pre></div><p>No surprises here, as we granted <code>alice</code> read and write access to <code>jobs</code>.</p>
<h2 id="testing-bobs-permissions">Testing <code>bob</code>&rsquo;s permissions</h2>
<p>Next, lets try viewing the job as <code>bob</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">kubectl --as<span class="o">=</span>system:serviceaccount:default:bob get <span class="nb">jobs</span>
</span></span><span class="line"><span class="cl"><span class="c1"># NAME             COMPLETIONS   DURATION   AGE</span>
</span></span><span class="line"><span class="cl"><span class="c1"># echo-job-jv8jh   1/1           3s         3m25s</span>
</span></span></code></pre></div><p>Looks good.  What happens when we try to create a job as <code>bob</code>?</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">kubectl create <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --as<span class="o">=</span>system:serviceaccount:default:bob <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  -f https://gist.githubusercontent.com/darrenclark/1e0810a0e864efe9bb712d3d0dd991c7/raw/83458fdf93c3aea1be292506e28a26c73e68e9db/job.yaml
</span></span><span class="line"><span class="cl"><span class="c1"># Error from server (Forbidden): error when creating &#34;https://gist.githubusercontent.com/darrenclark/1e0810a0e864efe9bb712d3d0dd991c7/raw/83458fdf93c3aea1be292506e28a26c73e68e9db/job.yaml&#34;:</span>
</span></span><span class="line"><span class="cl"><span class="c1"># jobs.batch is forbidden: User &#34;system:serviceaccount:default:bob&#34; </span>
</span></span><span class="line"><span class="cl"><span class="c1"># cannot create resource &#34;jobs&#34; in API group &#34;batch&#34; in the namespace</span>
</span></span><span class="line"><span class="cl"><span class="c1"># &#34;default&#34;</span>
</span></span></code></pre></div><p>As we expected!  We gave <code>bob</code> read-only access to jobs, so it makes sense we got an error back.</p>
<hr>
<p>I was quite happy to learn about the <code>--as</code> argument.  It made it <em>really</em> easy to test the permissions for my service account, and I could be confident I was giving it the minimum required permissions.</p>

    </div>
</article>

        </main>

        
        <footer class="mt-20 pt-8 border-t border-border-light dark:border-border-dark text-center text-gray-500 dark:text-gray-400 text-sm">
            <p>¬© 2025 Darren Clark</p>
            <p class="mt-1">
                <a href="http://creativecommons.org/licenses/by-sa/2.5/ca/" class="text-link-light dark:text-link-dark hover:opacity-70">CC BY-SA 2.5 CA</a> (content) / 
                <a href="https://unlicense.org" class="text-link-light dark:text-link-dark hover:opacity-70">Unlicense</a> (code snippets)
            </p>
        </footer>
    </div>

    <script>
        function toggleTheme() {
            const html = document.documentElement;
            if (html.classList.contains('dark')) {
                html.classList.remove('dark');
                localStorage.setItem('theme', 'light');
            } else {
                html.classList.add('dark');
                localStorage.setItem('theme', 'dark');
            }
        }

        
        const savedTheme = localStorage.getItem('theme') || 'light';
        if (savedTheme === 'dark') {
            document.documentElement.classList.add('dark');
        }
    </script>
</body>
</html>
